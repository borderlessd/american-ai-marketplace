<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>American AI Marketplace</title>
  <link rel="stylesheet" href="/assets/styles.css">
</head>
<body>
  <!-- NAV -->
  <div class="nav">
    <div><a href="/index.html">American AI Marketplace</a></div>
    <div>
      <a href="/index.html">Home</a>
      <a href="/loads.html">Find Loads</a>
      <a href="/register.html">Register</a>
      <a id="myBidsLink" href="#" style="display:none;">My Bids (<span id="bidCount">0</span>)</a>
      <a id="signinLink" href="#" onclick="openAuth();return false;">Sign In</a>
      <a id="signoutLink" href="#" style="display:none;" onclick="signout();return false;">Sign Out</a>
      <!-- Admin link only revealed when ?admin=true (handled in app.js) -->
      <a id="adminLink" href="#" style="display:none"
         onclick="document.getElementById('gateModal').classList.add('open');return false;">Admin</a>
    </div>
    <div style="margin-left:auto;display:flex;align-items:center;gap:8px;">
      <button id="darkToggle" class="btn secondary" style="padding:4px 8px;font-size:13px;">🌙 Dark</button>
    </div>
  </div>

  <!-- HERO -->
  <section class="hero">
    <h1>Move America, intelligently.</h1>
    <div class="wrap" style="text-align:center">
      <span class="badge">US-based</span>
      <span class="badge">MC/USDOT</span>
      <span class="badge">5% Marketplace Fee</span>
    </div>
  </section>

  <!-- CONTENT -->
  <div class="wrap">
    <!-- Controls row (+ right-aligned pager holder that app.js moves toolbar into) -->
    <div class="controls" style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;">
      <input id="q" class="input" placeholder="Search city, commodity, item…">
      <select id="commodity" class="input">
        <option value="">All commodities</option>
        <option>Vehicle</option><option>Boat</option><option>Motorcycle</option>
        <option>Household</option><option>LTL</option><option>Pets</option><option>Heavy Equipment</option>
      </select>
      <!-- IMPORTANT: this holder must exist so pagination can sit to the right -->
      <div id="loads-pager-holder" style="margin-left:auto;display:flex;align-items:center;gap:10px;"></div>
    </div>

    <!-- Cards grid (populated by /assets/app.js) -->
    <div id="grid" class="grid"></div>

    <!-- Bottom pagination (wired by /assets/app.js) -->
    <div id="pagerBottom" style="text-align:center;margin:20px 0;">
      <button id="prevPage" class="btn secondary">Prev</button>
      <span id="pageInfo">Page 1 / 1</span>
      <button id="nextPage" class="btn secondary">Next</button>
    </div>
  </div>

  <!-- FOOTER -->
  <div class="footer">
    <div class="wrap footer-note">© American AI Marketplace</div>
  </div>

  <!-- VIEW MODAL -->
  <div id="viewModal" class="modal"><div class="panel"><div id="viewContent"></div></div></div>

  <!-- AUTH MODAL (carriers) -->
  <div id="authModal" class="modal"><div class="panel">
    <div class="title">Sign in</div>
    <label>Email <input id="authEmail" type="email" class="input" placeholder="name@example.com"></label>
    <div style="height:8px"></div>
    <label>Password <input id="authPass" type="password" class="input" placeholder="Enter your password"></label>
    <div id="authError" class="error"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button class="btn secondary" onclick="closeAuth()">Cancel</button>
      <button class="btn" onclick="signin()">Continue</button>
    </div>
    <div style="text-align:center;margin-top:8px;font-size:13px;">
      Don’t have an account? <a href="/register.html">Register now</a>
    </div>
  </div></div>

  <!-- ADMIN GATE MODAL -->
  <div id="gateModal" class="modal"><div class="panel">
    <div class="title">Admin Access</div>
    <label>Username <input id="gateUser" class="input" placeholder="Enter a username"></label>
    <div style="height:8px"></div>
    <label>Password <input id="gatePass" type="password" class="input" placeholder="Enter your password"></label>
    <div id="gateError" class="error"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button class="btn secondary" onclick="document.getElementById('gateModal').classList.remove('open')">Cancel</button>
      <button class="btn" onclick="(function(){
        const u=document.getElementById('gateUser').value.trim();
        const p=document.getElementById('gatePass').value.trim();
        const okU='admin', okP='market';
        if(u===okU && p===okP){
          sessionStorage.setItem('aim_admin_ok','1');
          window.location.href='/admin/';
        }else{
          document.getElementById('gateError').textContent='Invalid username or password.';
        }
      })()">Enter</button>
    </div>
  </div></div>

  <!-- Scripts: Supabase must load before your app -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="/assets/app.js"></script>

  <!-- Dark mode + navbar auth/bids wiring (runs after app.js is available) -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Dark mode
      const btn = document.getElementById('darkToggle');
      const applyDark = () => {
        const dark = localStorage.getItem('aim_dark') === '1';
        document.body.classList.toggle('dark', dark);
        if (btn) btn.textContent = dark ? '☀️ Light' : '🌙 Dark';
      };
      if (btn) {
        btn.addEventListener('click', () => {
          const next = document.body.classList.toggle('dark');
          localStorage.setItem('aim_dark', next ? '1' : '0');
          btn.textContent = next ? '☀️ Light' : '🌙 Dark';
        });
      }
      applyDark();

      // Nav: sign in/out + My Bids (count)
      const signinLink = document.getElementById('signinLink');
      const signoutLink = document.getElementById('signoutLink');
      const myBidsLink  = document.getElementById('myBidsLink');
      const bidCountEl  = document.getElementById('bidCount');

      (async () => {
        try {
          const { data } = await sb.auth.getUser();
          if (data?.user?.id) {
            if (signinLink) signinLink.style.display = 'none';
            if (signoutLink) signoutLink.style.display = 'inline';
            if (myBidsLink)  myBidsLink.style.display  = 'inline';

            // Count this user's bids
            const { data: rows } = await sb
              .from('bids')
              .select('id', { count: 'exact', head: false })
              .eq('auth_user_id', data.user.id);
            if (Array.isArray(rows) && bidCountEl) bidCountEl.textContent = rows.length || 0;

            // Optional: click for a simple “my bids” filter (could route to a page later)
            myBidsLink && (myBidsLink.onclick = (e) => {
              e.preventDefault();
              alert('My Bids view coming next. For now, use Admin to see all bids.');
            });
          } else {
            if (signinLink) signinLink.style.display = 'inline';
            if (signoutLink) signoutLink.style.display = 'none';
            if (myBidsLink)  myBidsLink.style.display  = 'none';
          }
        } catch(e) {
          // non-fatal
        }
      })();

      // Expose closeAuth used in the Cancel button
      window.closeAuth = () => document.getElementById('authModal')?.classList.remove('open');
    });
  </script>
</body>
</html>